<!doctype html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ููุญุฉ ุงููุดุฑู โ ุญุจูุจุฉ</title>
    <link href="/static/css/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        html {
            direction: rtl
        }
    </style>
</head>

<body class="bg-gradient-to-br from-pink-50 to-indigo-50 min-h-screen flex items-center justify-center">
    <div class="max-w-3xl w-full p-6">
        <header class="mb-6 text-center">
            <h1 class="text-2xl font-extrabold text-pink-600">ููุญุฉ ุงููุดุฑู</h1>
            <p class="text-sm text-gray-600">ุตูุญุฉ ูุฎููุฉ ูุชุญุฏูุซ ุงูุฃุณุฆูุฉ (ูุญููุฉ ุจูููุฉ ุณุฑ) โ ุงูุชุฎุฒูู ูู ุงูุฐุงูุฑุฉ ููุท ูุณูุฎุชูู
                ุนูุฏ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู</p>
        </header>

        <main class="bg-white shadow-xl rounded-xl p-6 text-right">
            <section id="login">
                <label class="block text-sm text-gray-700 mb-1">ูููุฉ ุงููุฑูุฑ:</label>
                <input id="pwd" type="password" class="w-full p-2 border rounded mb-3" />
                <div class="flex justify-between items-center">
                    <div id="login-msg" class="text-sm text-red-600"></div>
                    <div>
                        <button id="verify" class="px-3 py-2 bg-pink-600 text-white rounded">ุชุฃููุฏ</button>
                        <a href="/" class="px-3 py-2 ml-2 border rounded">ุนูุฏุฉ</a>
                    </div>
                </div>
            </section>

            <section id="editor" class="hidden mt-4">
                <label class="block text-sm text-gray-700 mb-1">ุฃูุตู ูุตูููุฉ JSON ุฃู ุงูุตูุบุฉ ุงููุตูุฉ ูุชุนุฏุฏุฉ ุงูุฃุณุฆูุฉ (ุฃูุตู
                    50):</label>
                <textarea id="questions-json" class="w-full h-64 p-3 border rounded mb-3 shadow-sm"
                    placeholder='ูุซุงู JSON: [ {"question":"ุงูุชุจ...","options":["ุฃ","ุจ"],"answer":"ุฃ"} ]\nุฃู ุฃูุตู ุงูุตูุบุฉ ุงููุตูุฉ ุงููุชุนุฏุฏุฉ (ุงุณุญุจ/ุฃูุตู ุนุฏุฉ ุฃุณุฆูุฉ ููุตููุฉ ุจุณุทุฑ ูุงุฑุบ)'></textarea>
                <div class="text-xs text-gray-500 mb-2">ูุซุงู ุณุคุงู JSON (ูููู ูุตู ูุตูููุฉ
                    ูุงููุฉ):<br><code>{ "question": "ุงูุชุจ ุงููุตุทูุญ ุงูุนููู ููุฏูุงูุฉ ุนูู ุชุบูุฑ ููุถุน ุงูุฌุณู ุจูุฑูุฑ ุงูุฒูู.", "options": ["ุงููุณุงูุฉ", "ุงูุฅุฒุงุญุฉ", "ุงูุณุฑุนุฉ", "ุงูุชุณุงุฑุน"], "answer": "ุงูุฅุฒุงุญุฉ" }</code>
                </div>
                <div class="flex items-center justify-between">
                    <div><span id="preview-count" class="text-sm text-gray-600">ุนุฏุฏ ุงูุฃุณุฆูุฉ: 0</span></div>
                    <div>
                        <button id="save"
                            class="px-3 py-2 bg-gradient-to-r from-green-500 to-emerald-400 text-white rounded shadow">ุญูุธ</button>
                        <button id="logout" class="px-3 py-2 ml-2 border rounded">ุฎุฑูุฌ</button>
                    </div>
                </div>
                <div id="save-msg" class="mt-3 text-sm"></div>
            </section>
        </main>
    </div>

    <script>
        const API_VERIFY = '/admin/verify';
        const API_UPDATE = '/admin/update_questions';
        // server-side known logged-in state
        const LOGGED_IN = {{ 'true' if logged_in else 'false' }};

        const $ = (s) => document.querySelector(s);

        function validateQuestions(arr) {
            if (!Array.isArray(arr)) throw new Error('ุงููุฏุฎู ูุฌุจ ุฃู ูููู ูุตูููุฉ JSON');
            if (arr.length === 0) throw new Error('ุงููุตูููุฉ ูุงุฑุบุฉ');
            if (arr.length > 50) throw new Error('ุงูุญุฏ ุงูุฃูุตู 50 ุณุคุงููุง');
            arr.forEach((q, i) => {
                if (typeof q.question !== 'string' || !q.question.trim()) throw new Error(`ุงูุณุคุงู ุฑูู ${i + 1} ุบูุฑ ุตุงูุญ`);
                if (!Array.isArray(q.options) || q.options.length < 2) throw new Error(`ุงูุณุคุงู ุฑูู ${i + 1} ูุฌุจ ุฃู ูุญุชูู ุนูู ูุตูููุฉ ุฎูุงุฑุงุช (2 ุนูู ุงูุฃูู)`);
                if (typeof q.answer !== 'string' || !q.answer.trim()) throw new Error(`ุงูุณุคุงู ุฑูู ${i + 1} ูุฌุจ ุฃู ูุญุชูู ุนูู ุฅุฌุงุจุฉ ุตุญูุญุฉ ููุต`);
                if (!q.options.includes(q.answer)) throw new Error(`ุงูุณุคุงู ุฑูู ${i + 1} ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูุฌุจ ุฃู ุชููู ูู ุจูู ุงูุฎูุงุฑุงุช`);
            });
            return true;
        }

        // show editor immediately if server says we're logged in
        if (LOGGED_IN) {
            $('#login').classList.add('hidden');
            $('#editor').classList.remove('hidden');
            $('#save-msg').textContent = '';
            $('#questions-json').focus();
        }

        document.getElementById('verify').addEventListener('click', async () => {
            const pwd = $('#pwd').value;
            $('#login-msg').textContent = '';
            try {
                const res = await fetch(API_VERIFY, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pwd }) });
                if (res.ok) {
                    // show editor
                    $('#login').classList.add('hidden');
                    $('#editor').classList.remove('hidden');
                    $('#save-msg').textContent = '';
                    $('#questions-json').focus();
                } else {
                    $('#login-msg').textContent = 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.';
                }
            } catch (e) { $('#login-msg').textContent = 'ุฎุทุฃ ูู ุงูุงุชุตุงู.'; }
        });

        $('#questions-json').addEventListener('input', () => {
            const txt = $('#questions-json').value.trim();
            $('#save-msg').textContent = '';
            $('#save-msg').classList.remove('text-red-600', 'text-green-600', 'text-yellow-600');
            if (!txt) { $('#preview-count').textContent = 'ุนุฏุฏ ุงูุฃุณุฆูุฉ: 0'; return; }
            try {
                const parsed = JSON.parse(txt);
                $('#preview-count').textContent = `ุนุฏุฏ ุงูุฃุณุฆูุฉ: ${Array.isArray(parsed) ? parsed.length : 0}`;
            } catch (e) {
                // not JSON; show bulk/text mode hint
                // quick heuristic: count blocks separated by blank line
                const blocks = txt.split(/\n\s*\n/).filter(b => b.trim());
                $('#preview-count').textContent = `ูุดู ุงูุตูุบุฉ ุงููุตูุฉ: ${blocks.length} ุณุคุงููุง ุชูุฑูุจูุง`;
                $('#save-msg').textContent = 'ุงููุต ููุณ JSON: ุนูุฏ ุงูุญูุธ ุณููุญุงูู ุงูุฎุงุฏู ุชุญููู ุตูุบุฉ ุงูุฃุณุฆูุฉ ุงููุชุนุฏุฏุฉ.';
                $('#save-msg').classList.add('text-yellow-600');
            }
        });

        document.getElementById('save').addEventListener('click', async () => {
            const pwd = $('#pwd').value;
            const txt = $('#questions-json').value.trim();
            $('#save-msg').textContent = '';
            $('#save-msg').classList.remove('text-red-600', 'text-green-600', 'text-yellow-600');

            // Try parse as JSON array first
            let isJson = false;
            let parsed = null;
            try {
                parsed = JSON.parse(txt);
                isJson = true;
            } catch (e) {
                isJson = false;
            }

            if (isJson) {
                try {
                    validateQuestions(parsed);
                } catch (e) { $('#save-msg').textContent = e.message; $('#save-msg').classList.add('text-red-600'); return; }
            }

            try {
                let body;
                if (isJson) {
                    body = JSON.stringify({ password: pwd, questions: parsed });
                } else {
                    // send raw text and let server parse it (bulk format)
                    if (!txt) { $('#save-msg').textContent = 'ูุง ููุฌุฏ ูุต ููุญูุธ.'; $('#save-msg').classList.add('text-red-600'); return; }
                    body = JSON.stringify({ password: pwd, questions_raw: txt });
                }
                const res = await fetch(API_UPDATE, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body });
                const d = await res.json().catch(() => ({}));
                if (res.ok) {
                    let msgText = `๐ ุชู ุงูุญูุธ โ ุชูุช ูุนุงูุฌุฉ ${d.count} ุณุคุงููุง.`;
                    if (d.mtime) msgText += ` (mtime: ${d.mtime})`;
                    $('#save-msg').textContent = msgText;
                    $('#save-msg').classList.add('text-green-600');
                    // a little motivational message
                    const msg = document.createElement('div');
                    msg.className = 'mt-2 text-sm text-gray-700';
                    msg.textContent = 'ุนูู ุฑุงุฆุน โ ุดูุฑูุง ููุณุงููุชู ูู ุฅุซุฑุงุก ูุญุชูู ุงูุงุฎุชุจุงุฑุงุช!';
                    const parent = $('#save-msg').parentNode;
                    // remove old motivational messages
                    const old = parent.querySelector('.motivational');
                    if (old) old.remove();
                    msg.classList.add('motivational');
                    parent.appendChild(msg);
                } else if (res.status === 403) {
                    $('#save-msg').textContent = 'ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.'; $('#save-msg').classList.add('text-red-600');
                } else {
                    $('#save-msg').textContent = d.error || 'ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ.'; $('#save-msg').classList.add('text-red-600');
                    if (d.warning === 'backup_failed') {
                        const w = document.createElement('div');
                        w.className = 'text-xs text-yellow-600 mt-1';
                        w.textContent = 'ุชู ุงูุญูุธ ููู ูุดู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุนูู ุงูุฎุงุฏู.';
                        $('#save-msg').parentNode.appendChild(w);
                    }
                }
            } catch (e) { $('#save-msg').textContent = 'ุฎุทุฃ ูู ุงูุงุชุตุงู.'; $('#save-msg').classList.add('text-red-600'); }
        });

        document.getElementById('test-storage').addEventListener('click', async () => {
            $('#storage-test-msg').textContent = 'ุฌุงุฑู ุงูุงุฎุชุจุงุฑ...';
            $('#storage-test-msg').className = 'mt-2 text-sm text-gray-700';
            try {
                const res = await fetch('/admin/test_storage');
                const d = await res.json().catch(() => ({}));
                if (res.ok) {
                    if (d.in_memory) {
                        $('#storage-test-msg').textContent = `โ ุงูุชุฎุฒูู ูุนูู ุจุงูุฐุงูุฑุฉ. ุนุฏุฏ ุงูุฃุณุฆูุฉ: ${d.count}`;
                        $('#storage-test-msg').className = 'mt-2 text-sm text-green-600';
                    } else {
                        $('#storage-test-msg').textContent = 'โ๏ธ ุงูุชุฎุฒูู ููุณ ุจุงูุฐุงูุฑุฉ.';
                        $('#storage-test-msg').className = 'mt-2 text-sm text-red-600';
                    }
                } else {
                    $('#storage-test-msg').textContent = d.error || 'ุฎุทุฃ ุฃุซูุงุก ุงูุงุฎุชุจุงุฑ.';
                    $('#storage-test-msg').className = 'mt-2 text-sm text-red-600';
                }
            } catch (e) {
                $('#storage-test-msg').textContent = 'ุฎุทุฃ ูู ุงูุงุชุตุงู.';
                $('#storage-test-msg').className = 'mt-2 text-sm text-red-600';
            }
        });

        document.getElementById('logout').addEventListener('click', () => {
            $('#editor').classList.add('hidden');
            $('#login').classList.remove('hidden');
            $('#pwd').value = '';
            $('#questions-json').value = '';
            $('#preview-count').textContent = 'ุนุฏุฏ ุงูุฃุณุฆูุฉ: 0';
            $('#login-msg').textContent = '';
            $('#save-msg').textContent = '';
        });
    </script>
</body>

</html>